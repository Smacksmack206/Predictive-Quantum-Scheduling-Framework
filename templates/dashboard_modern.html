{% extends "base_modern.html" %}

{% block content %}
<div x-data="dashboard()" x-init="init()" class="slide-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            Quantum-ML Optimization System
        </h1>
        <p class="text-gray-400">Real-time power optimization with quantum computing and machine learning</p>
    </div>
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Energy Saved -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 hover:border-green-500 transition">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm font-medium">Energy Saved</span>
                <span class="text-3xl">‚ö°</span>
            </div>
            <div class="text-4xl font-bold text-green-400 mb-1" x-text="energySaved + '%'">0%</div>
            <div class="text-xs text-gray-500">Real-time measurement</div>
            <div class="mt-3 h-1 bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full bg-green-500 transition-all duration-500" :style="`width: ${Math.min(energySaved, 100)}%`"></div>
            </div>
        </div>
        
        <!-- Quantum Advantage -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 hover:border-blue-500 transition">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm font-medium">Quantum Advantage</span>
                <span class="text-3xl">‚öõÔ∏è</span>
            </div>
            <div class="text-4xl font-bold text-blue-400 mb-1" x-text="quantumAdvantage + 'x'">0x</div>
            <div class="text-xs text-gray-500">Speedup factor</div>
            <div class="mt-3 flex items-center space-x-1">
                <template x-for="i in Math.min(Math.floor(quantumAdvantage), 8)" :key="i">
                    <div class="w-2 h-6 bg-blue-500 rounded"></div>
                </template>
            </div>
        </div>
        
        <!-- ML Models -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 hover:border-purple-500 transition">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm font-medium">ML Models</span>
                <span class="text-3xl">üß†</span>
            </div>
            <div class="text-4xl font-bold text-purple-400 mb-1" x-text="mlModels">0</div>
            <div class="text-xs text-gray-500">Trained & learning</div>
            <div class="mt-3 text-xs text-purple-300" x-show="mlModels > 0">
                <span x-text="`${mlAccuracy}% accuracy`">0% accuracy</span>
            </div>
        </div>
        
        <!-- Optimizations -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 hover:border-cyan-500 transition">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm font-medium">Optimizations</span>
                <span class="text-3xl">üöÄ</span>
            </div>
            <div class="text-4xl font-bold text-cyan-400 mb-1" x-text="optimizations">0</div>
            <div class="text-xs text-gray-500">Total completed</div>
            <div class="mt-3 text-xs text-cyan-300" x-show="optimizations > 0">
                <span x-text="`${qubits} qubits active`">0 qubits</span>
            </div>
        </div>
    </div>
    
    <!-- Real-time Graph -->
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Energy Savings Over Time</h2>
            <span class="text-sm text-gray-400" x-text="`Last updated: ${lastUpdate}`"></span>
        </div>
        <div style="height: 300px;">
            <canvas id="energyChart"></canvas>
        </div>
    </div>
    
    <!-- System Status -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Active Systems -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700">
            <h3 class="text-lg font-bold mb-4">üöÄ Active Systems</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                    <span>Quantum-ML Engine</span>
                    <span class="text-green-400 text-sm" x-text="quantumEngine">Loading...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                    <span>Idle Manager</span>
                    <span class="text-green-400 text-sm">‚úÖ Active</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                    <span>Battery Guardian</span>
                    <span class="text-green-400 text-sm">‚úÖ Active</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg" x-show="quantumMaxActive">
                    <span>Quantum Max (48-qubit)</span>
                    <span class="text-purple-400 text-sm">‚úÖ Ultimate Mode</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700">
            <h3 class="text-lg font-bold mb-4">üìä System Info</h3>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-400">CPU Usage</span>
                    <span x-text="cpuUsage + '%'">0%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Memory Usage</span>
                    <span x-text="memoryUsage + '%'">0%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Battery Level</span>
                    <span x-text="batteryLevel + '%'">0%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Thermal State</span>
                    <span x-text="thermalState">Normal</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <button @click="runOptimization()" 
                :disabled="optimizing"
                class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 text-white font-bold py-4 px-6 rounded-xl transition shadow-lg hover:shadow-xl">
            <span x-show="!optimizing">üöÄ Run Optimization</span>
            <span x-show="optimizing">‚è≥ Optimizing...</span>
        </button>
        
        <button @click="toggleQuantumMax()" 
                class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-4 px-6 rounded-xl transition shadow-lg hover:shadow-xl">
            ‚öõÔ∏è Quantum Max Mode
        </button>
        
        <button @click="viewDetails()" 
                class="bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 px-6 rounded-xl transition shadow-lg hover:shadow-xl">
            üìä View Details
        </button>
    </div>
</div>

<script>
function dashboard() {
    return {
        energySaved: 0,
        quantumAdvantage: 0,
        mlModels: 0,
        mlAccuracy: 0,
        optimizations: 0,
        qubits: 0,
        quantumEngine: 'Loading...',
        quantumMaxActive: false,
        cpuUsage: 0,
        memoryUsage: 0,
        batteryLevel: 0,
        thermalState: 'Normal',
        lastUpdate: 'Never',
        optimizing: false,
        chart: null,
        
        init() {
            this.fetchData();
            this.initChart();
            setInterval(() => this.fetchData(), 5000);
        },
        
        async fetchData() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Extract from nested structure
                const stats = data.stats || {};
                const metrics = data.real_time_metrics || {};
                
                this.energySaved = (stats.energy_saved || 0).toFixed(1);
                this.quantumAdvantage = (stats.quantum_advantage || 1).toFixed(1);
                this.mlModels = stats.ml_models_trained || 0;
                this.mlAccuracy = ((stats.ml_average_accuracy || 0) * 100).toFixed(0);
                this.optimizations = stats.optimizations_run || 0;
                this.qubits = stats.quantum_circuits_active || 0;
                this.quantumEngine = stats.quantum_engine || 'Unknown';
                this.quantumMaxActive = stats.quantum_max_active || false;
                
                this.cpuUsage = (metrics.cpu_percent || 0).toFixed(1);
                this.memoryUsage = (metrics.memory_percent || 0).toFixed(1);
                this.batteryLevel = (metrics.battery_level || 0).toFixed(0);
                this.thermalState = metrics.thermal_state || 'Normal';
                
                this.lastUpdate = new Date().toLocaleTimeString();
                this.updateChart(stats);
            } catch (error) {
                console.error('Fetch error:', error);
            }
        },
        
        initChart() {
            const ctx = document.getElementById('energyChart');
            this.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Energy Saved (%)',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'rgb(34, 197, 94)',
                            bodyColor: 'rgb(255, 255, 255)'
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                        }
                    }
                }
            });
        },
        
        updateChart(data) {
            if (!this.chart) return;
            
            const now = new Date().toLocaleTimeString();
            this.chart.data.labels.push(now);
            this.chart.data.datasets[0].data.push(data.energy_saved || 0);
            
            if (this.chart.data.labels.length > 20) {
                this.chart.data.labels.shift();
                this.chart.data.datasets[0].data.shift();
            }
            
            this.chart.update('none');
        },
        
        async runOptimization() {
            this.optimizing = true;
            try {
                const response = await fetch('/api/optimize', { method: 'POST' });
                const data = await response.json();
                
                // Show success notification
                this.showNotification(`‚úÖ Saved ${data.energy_saved}%`, 'success');
                
                await this.fetchData();
            } catch (error) {
                this.showNotification('‚ùå Optimization failed', 'error');
            } finally {
                this.optimizing = false;
            }
        },
        
        toggleQuantumMax() {
            window.location.href = '/quantum';
        },
        
        viewDetails() {
            window.location.href = '/system-control';
        },
        
        showNotification(message, type) {
            // Simple notification (can be enhanced)
            alert(message);
        }
    }
}
</script>
{% endblock %}
